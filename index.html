<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Konverter File Generasi Baru</title>

    <!-- Library untuk membaca/menulis file Excel (SheetJS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Library untuk membuat PDF (jsPDF & jsPDF-AutoTable) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Tailwind CSS untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter untuk tampilan yang bersih dan modern -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Ikon (Feather Icons) -->
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        /* Menggunakan font Inter sebagai default */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Warna dasar GitHub Dark */
            color: #c9d1d9;
        }

        /* Efek Aurora di background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(13, 110, 253, 0.15), transparent 40%),
                radial-gradient(circle at 85% 30%, rgba(214, 40, 40, 0.15), transparent 40%);
            filter: blur(100px);
            z-index: -1;
        }

        /* Styling untuk area upload file (dropzone) */
        .drop-zone {
            border: 2px dashed #30363d;
            background-color: rgba(22, 27, 34, 0.5);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .drop-zone.dragover, .drop-zone:hover {
            background-color: rgba(33, 38, 45, 0.7);
            border-color: #2f81f7;
        }

        /* Styling glassmorphism untuk panel utama */
        .glass-panel {
            background: rgba(13, 17, 23, 0.6);
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        /* Styling tombol dengan gradien dan efek hover */
        .btn-gradient {
            background-image: linear-gradient(to right, #238636, #2ea043);
            border: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px 0 rgba(46, 160, 67, 0.3);
        }
        .btn-gradient:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 20px 0 rgba(46, 160, 67, 0.5);
        }
        .btn-secondary {
             background-color: #21262d;
             border: 1px solid #30363d;
             transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #30363d;
            border-color: #8b949e;
        }

        /* Custom scrollbar untuk pratinjau tabel */
        .preview-container::-webkit-scrollbar { width: 8px; height: 8px; }
        .preview-container::-webkit-scrollbar-track { background: #0d1117; }
        .preview-container::-webkit-scrollbar-thumb { background-color: #21262d; border-radius: 10px; border: 2px solid #0d1117; }
        .preview-container::-webkit-scrollbar-thumb:hover { background-color: #30363d; }
        
        /* Menyembunyikan input file asli */
        #file-input { display: none; }
        
        /* Spinner untuk indikator loading */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: #2f81f7; /* Biru */
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-6xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-6xl font-extrabold text-white tracking-tight">
                Transformasi <span class="text-blue-400">Data</span> Instan
            </h1>
            <p class="mt-4 text-lg text-gray-400 max-w-2xl mx-auto">Unggah file CSV atau Excel, saring data sesuai kebutuhan, lalu ekspor ke format PDF atau Excel dengan mudah.</p>
        </header>

        <main id="converter-app" class="glass-panel rounded-2xl p-6 md:p-8">
            
            <!-- Tampilan Awal: Area Upload -->
            <div id="upload-area">
                <label for="file-input" class="drop-zone w-full p-10 rounded-xl flex flex-col items-center justify-center cursor-pointer text-gray-400">
                    <i data-feather="upload" class="w-16 h-16 mb-5 text-blue-500"></i>
                    <h2 class="text-2xl font-bold text-white">Letakkan File Anda Di Sini</h2>
                    <p class="mt-2 text-base">atau klik untuk menelusuri dari perangkat</p>
                    <p class="text-sm mt-5 bg-gray-700 px-3 py-1 rounded-full font-medium">Mendukung .csv, .xls, .xlsx</p>
                </label>
                <input type="file" id="file-input" accept=".csv,.xls,.xlsx">
            </div>

            <!-- Tampilan Proses: Loading Spinner -->
            <div id="loading-area" class="hidden flex-col items-center justify-center py-16">
                <div class="spinner"></div>
                <p class="mt-6 text-xl font-medium text-gray-300">Memproses data Anda...</p>
            </div>

            <!-- Tampilan Hasil: Pratinjau & Opsi Unduh -->
            <div id="workspace-area" class="hidden">
                <!-- Info File & Tombol Reset -->
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <div class="flex items-center text-lg bg-gray-800 px-4 py-2 rounded-lg border border-gray-700">
                        <i data-feather="file-text" class="w-5 h-5 mr-3 text-blue-400"></i>
                        <span id="file-info" class="font-medium"></span>
                    </div>
                    <button id="reset-btn" class="btn-secondary w-full sm:w-auto font-bold py-2 px-5 rounded-lg flex items-center justify-center">
                        <i data-feather="refresh-cw" class="w-5 h-5 mr-2"></i>
                        Unggah File Baru
                    </button>
                </div>

                <!-- Filter Data -->
                <div id="filter-section" class="mb-6 bg-gray-900/50 p-5 rounded-lg border border-gray-700">
                    <h3 class="text-xl font-semibold mb-4 flex items-center"><i data-feather="filter" class="w-5 h-5 mr-3 text-green-400"></i>Saring Data</h3>
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                        <div class="md:col-span-5">
                            <label for="filter-column" class="block text-sm font-medium text-gray-300 mb-1">Pilih Kolom</label>
                            <select id="filter-column" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></select>
                        </div>
                        <div class="md:col-span-5">
                            <label for="filter-value" class="block text-sm font-medium text-gray-300 mb-1">Cari Kata Kunci</label>
                            <input type="text" id="filter-value" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ketikkan nilai untuk difilter...">
                        </div>
                        <div class="md:col-span-2 flex gap-2">
                            <button id="apply-filter-btn" class="btn-gradient w-full text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center">
                                <i data-feather="search" class="w-5 h-5"></i>
                            </button>
                            <button id="reset-filter-btn" class="btn-secondary w-auto py-2 px-3 rounded-lg flex items-center justify-center" title="Hapus Filter">
                                <i data-feather="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Pratinjau Data -->
                <div>
                    <h3 class="text-2xl font-bold mb-4 text-white">Pratinjau Data</h3>
                    <div class="preview-container max-h-96 overflow-auto border border-gray-700 rounded-lg bg-gray-900/70">
                        <table class="w-full text-sm text-left" id="preview-table">
                            <!-- Konten tabel akan diisi oleh JavaScript -->
                        </table>
                    </div>
                </div>

                <!-- Opsi Unduhan -->
                <div class="mt-8">
                    <h3 class="text-2xl font-bold mb-4 text-white">Opsi Ekspor</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Opsi Unduh PDF -->
                        <div class="bg-gray-800/50 p-6 rounded-xl border border-gray-700 flex flex-col">
                            <h4 class="text-xl font-semibold mb-4 flex items-center"><i data-feather="file" class="w-5 h-5 mr-3 text-red-400"></i>Ekspor ke PDF</h4>
                            <p class="text-gray-400 mb-4 flex-grow">Unduh data yang telah difilter sebagai dokumen PDF. Anda bisa menambahkan judul kop surat.</p>
                            <div class="space-y-4">
                                <input type="text" id="pdf-title-input" class="w-full bg-gray-900 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-500 focus:ring-2 focus:ring-red-500 focus:border-red-500" placeholder="Judul Kop Surat (Opsional)">
                                <button id="download-pdf-btn" class="btn-secondary w-full font-bold py-2.5 px-4 rounded-lg flex items-center justify-center">
                                    <i data-feather="download" class="w-5 h-5 mr-2"></i>
                                    Unduh PDF
                                </button>
                            </div>
                        </div>

                        <!-- Opsi Unduh Excel -->
                        <div class="bg-gray-800/50 p-6 rounded-xl border border-gray-700 flex flex-col">
                            <h4 class="text-xl font-semibold mb-4 flex items-center"><i data-feather="grid" class="w-5 h-5 mr-3 text-green-400"></i>Ekspor ke Excel</h4>
                             <p class="text-gray-400 mb-4 flex-grow">Simpan seluruh data asli (tanpa filter) ke dalam format file <code class="bg-gray-700 text-xs p-1 rounded">.xlsx</code>.</p>
                             <div class="mt-auto">
                                <button id="download-excel-btn" class="btn-gradient w-full text-white font-bold py-2.5 px-4 rounded-lg flex items-center justify-center">
                                    <i data-feather="download-cloud" class="w-5 h-5 mr-2"></i>
                                    Unduh Excel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <footer class="text-center mt-10 text-gray-500 text-sm">
            <p>&copy; 2025 | Dibuat dengan <span class="text-red-500">❤️</span> oleh Mas Andy.</p>
        </footer>
    </div>

    <script>
        // Inisialisasi Feather Icons
        feather.replace();

        // Referensi Elemen DOM
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const loadingArea = document.getElementById('loading-area');
        const workspaceArea = document.getElementById('workspace-area');
        const fileInfo = document.getElementById('file-info');
        const previewTable = document.getElementById('preview-table');
        const pdfTitleInput = document.getElementById('pdf-title-input');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const downloadExcelBtn = document.getElementById('download-excel-btn');
        const resetBtn = document.getElementById('reset-btn');
        
        // Elemen Filter
        const filterColumnSelect = document.getElementById('filter-column');
        const filterValueInput = document.getElementById('filter-value');
        const applyFilterBtn = document.getElementById('apply-filter-btn');
        const resetFilterBtn = document.getElementById('reset-filter-btn');

        // Variabel global
        let parsedData = [];
        let filteredData = []; // Untuk menyimpan data hasil filter
        let originalFileName = 'hasil-konversi';

        // --- FUNGSI UTAMA ---

        const handleFile = (file) => {
            if (!file) return;
            const isCsv = file.name.toLowerCase().endsWith('.csv');
            const isExcel = file.name.toLowerCase().endsWith('.xls') || file.name.toLowerCase().endsWith('.xlsx');
            if (!isCsv && !isExcel) {
                showToast('Format file tidak didukung. Harap gunakan CSV atau Excel.', 'error');
                return;
            }
            originalFileName = file.name.replace(/\.(csv|xlsx|xls)$/i, '');
            fileInfo.textContent = file.name;
            uploadArea.classList.add('hidden');
            loadingArea.classList.remove('hidden');
            workspaceArea.classList.add('hidden');
            
            setTimeout(() => {
                const reader = new FileReader();
                reader.onerror = () => { showToast('Gagal membaca file.', 'error'); resetApp(); };
                if (isCsv) {
                    reader.onload = (e) => { try { processCsv(e.target.result); } catch (error) { console.error("Error CSV:", error); showToast('Gagal memproses file CSV.', 'error'); resetApp(); } };
                    reader.readAsText(file);
                } else {
                    reader.onload = (e) => processExcel(e.target.result);
                    reader.readAsArrayBuffer(file);
                }
            }, 500);
        };

        const detectDelimiter = (csvText) => {
            const delimiters = [',', ';', '\t', '|'];
            const firstLine = csvText.slice(0, 1000).split('\n')[0];
            let bestDelimiter = ',';
            let maxCount = 0;
            delimiters.forEach(d => { const count = firstLine.split(d).length; if (count > maxCount) { maxCount = count; bestDelimiter = d; } });
            return bestDelimiter;
        };

        const processCsv = (csvText) => {
            const delimiter = detectDelimiter(csvText);
            const rows = [];
            let currentRow = [];
            let currentField = '';
            let inQuotes = false;
            csvText = csvText.trim() + '\n';
            for (let i = 0; i < csvText.length; i++) {
                const char = csvText[i];
                const nextChar = csvText[i + 1];
                if (inQuotes) {
                    if (char === '"' && nextChar === '"') { currentField += '"'; i++; } 
                    else if (char === '"') { inQuotes = false; } 
                    else { currentField += char; }
                } else {
                    if (char === '"') { inQuotes = true; } 
                    else if (char === delimiter) { currentRow.push(currentField.trim()); currentField = ''; } 
                    else if (char === '\n' || char === '\r') {
                        currentRow.push(currentField.trim());
                        if (currentRow.length > 1 || (currentRow.length === 1 && currentRow[0] !== '')) { rows.push(currentRow); }
                        currentRow = []; currentField = '';
                        if (char === '\r' && nextChar === '\n') { i++; }
                    } else { currentField += char; }
                }
            }
            parsedData = rows;
            finishProcessing();
        };

        const processExcel = (arrayBuffer) => {
            try {
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                parsedData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });
                finishProcessing();
            } catch (error) {
                console.error("Error Excel:", error);
                showToast('Gagal memproses file Excel.', 'error');
                resetApp();
            }
        };

        const finishProcessing = () => {
             if (!parsedData || parsedData.length === 0) {
                showToast('File kosong atau tidak dapat dibaca.', 'error');
                resetApp();
                return;
            }
            populateFilterOptions();
            resetFilter(); // Tampilkan semua data saat pertama kali
            loadingArea.classList.add('hidden');
            workspaceArea.classList.remove('hidden');
            showToast('File berhasil diproses!', 'success');
        };

        const populateFilterOptions = () => {
            filterColumnSelect.innerHTML = '';
            if (parsedData.length > 0) {
                parsedData[0].forEach((header, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = header;
                    filterColumnSelect.appendChild(option);
                });
            }
        };

        const renderPreview = (dataToRender) => {
            previewTable.innerHTML = '';
            if (!dataToRender || dataToRender.length <= 1) { // Check jika hanya ada header
                const tbody = document.createElement('tbody');
                const row = tbody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = parsedData.length > 0 ? parsedData[0].length : 1;
                cell.textContent = 'Tidak ada data yang cocok dengan filter Anda.';
                cell.className = 'text-center text-gray-400 py-10';
                previewTable.appendChild(tbody);
                if (dataToRender && dataToRender.length > 0) { // Tetap tampilkan header jika tidak ada data
                    const thead = document.createElement('thead');
                    thead.className = "text-xs text-gray-400 uppercase bg-gray-800";
                    const headerRow = document.createElement('tr');
                    dataToRender[0].forEach(headerText => {
                        const th = document.createElement('th');
                        th.scope = "col";
                        th.className = "px-6 py-3 tracking-wider";
                        th.textContent = headerText;
                        headerRow.appendChild(th);
                    });
                    thead.appendChild(headerRow);
                    previewTable.prepend(thead); // Prepend agar muncul di atas pesan "no data"
                }
                return;
            };

            const headerCount = dataToRender[0].length;
            const thead = document.createElement('thead');
            thead.className = "text-xs text-gray-400 uppercase bg-gray-800";
            const headerRow = document.createElement('tr');
            dataToRender[0].forEach(headerText => {
                const th = document.createElement('th');
                th.scope = "col";
                th.className = "px-6 py-3 tracking-wider";
                th.textContent = headerText;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            previewTable.appendChild(thead);

            const tbody = document.createElement('tbody');
            dataToRender.slice(1, 101).forEach(rowData => { // Batasi pratinjau hingga 100 baris
                const row = document.createElement('tr');
                row.className = "bg-gray-900 border-b border-gray-700 hover:bg-gray-800/50";
                for (let i = 0; i < headerCount; i++) {
                    const cellData = rowData[i] || "";
                    const td = document.createElement('td');
                    td.className = "px-6 py-4";
                    td.textContent = cellData;
                    row.appendChild(td);
                }
                tbody.appendChild(row);
            });
            previewTable.appendChild(tbody);
        };
        
        const applyFilter = () => {
            const columnIndex = filterColumnSelect.value;
            const filterText = filterValueInput.value.toLowerCase().trim();

            if (filterText === '') {
                resetFilter();
                return;
            }

            const header = parsedData[0];
            const body = parsedData.slice(1);
            
            const results = body.filter(row => {
                const cellValue = row[columnIndex] ? String(row[columnIndex]).toLowerCase().trim() : '';
                return cellValue.includes(filterText);
            });

            filteredData = [header, ...results];
            renderPreview(filteredData);
            showToast(`${results.length} baris data ditemukan.`, 'info');
        };

        const resetFilter = () => {
            filterValueInput.value = '';
            filteredData = [...parsedData];
            renderPreview(filteredData);
        };

        const downloadExcel = () => {
            if (parsedData.length === 0) { showToast('Tidak ada data untuk diunduh.', 'error'); return; }
            const worksheet = XLSX.utils.aoa_to_sheet(parsedData); // Selalu unduh data lengkap
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Data Lengkap');
            XLSX.writeFile(workbook, `${originalFileName}_lengkap.xlsx`);
        };

        const downloadPdf = () => {
            const dataToDownload = filteredData.length > 1 ? filteredData : parsedData;
            if (dataToDownload.length <= 1) { // <= 1 karena header selalu ada
                showToast('Tidak ada data untuk diunduh (cek filter Anda).', 'error');
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });

            const title = pdfTitleInput.value.trim() || originalFileName;
            const head = [dataToDownload[0]];
            const body = dataToDownload.slice(1);

            doc.autoTable({
                head: head,
                body: body,
                startY: 80,
                theme: 'grid',
                styles: { font: 'helvetica', fillColor: [22, 27, 34], textColor: [201, 209, 217], lineColor: [48, 54, 61], lineWidth: 0.5 },
                headStyles: { fillColor: [33, 38, 45], textColor: [240, 246, 252], fontStyle: 'bold' },
                didDrawPage: function (data) {
                    // Kop Surat
                    doc.setFontSize(18);
                    doc.setTextColor('#2f81f7'); // Warna Biru
                    doc.setFont('helvetica', 'bold');
                    doc.text(title, doc.internal.pageSize.getWidth() / 2, 40, { align: 'center' });

                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(150); // Warna abu-abu
                    doc.text(`Sumber Data: ${fileInfo.textContent}`, doc.internal.pageSize.getWidth() / 2, 55, { align: 'center' });
                    
                    // Garis pemisah
                    doc.setDrawColor(48, 54, 61); // Warna garis
                    doc.setLineWidth(1);
                    doc.line(data.settings.margin.left, 68, doc.internal.pageSize.getWidth() - data.settings.margin.right, 68);
                },
            });

            doc.save(`${originalFileName}_difilter.pdf`);
        };

        const resetApp = () => {
            parsedData = [];
            filteredData = [];
            originalFileName = 'hasil-konversi';
            fileInput.value = '';
            pdfTitleInput.value = '';
            filterValueInput.value = '';
            uploadArea.classList.remove('hidden');
            loadingArea.classList.add('hidden');
            workspaceArea.classList.add('hidden');
        };

        const showToast = (message, type = 'info') => {
            const toast = document.createElement('div');
            const colors = { 
                info: 'bg-blue-500', 
                success: 'bg-green-500', 
                error: 'bg-red-600' 
            };
            toast.className = `fixed bottom-5 right-5 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform translate-y-24 opacity-0 transition-all duration-300 ease-out ${colors[type]}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => { toast.classList.remove('translate-y-24', 'opacity-0'); }, 100);
            setTimeout(() => { 
                toast.classList.add('opacity-0'); 
                setTimeout(() => toast.remove(), 500);
            }, 4000);
        };

        // --- EVENT LISTENERS ---
        fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
        const dropZone = document.querySelector('.drop-zone');
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); });
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); handleFile(e.dataTransfer.files[0]); });
        
        applyFilterBtn.addEventListener('click', applyFilter);
        resetFilterBtn.addEventListener('click', () => {
            resetFilter();
            showToast('Filter telah dihapus.', 'info');
        });
        filterValueInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') applyFilter(); });
        
        downloadExcelBtn.addEventListener('click', downloadExcel);
        downloadPdfBtn.addEventListener('click', downloadPdf);
        resetBtn.addEventListener('click', resetApp);

    </script>
</body>
</html>
