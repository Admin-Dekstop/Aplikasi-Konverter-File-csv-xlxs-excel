<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="JQ7zcPvtMjzKKZzN0noLegQGbqPPYihU7nTby6RdO0o" />
    <h1>Transformasi Data Instan</h1>
    <!-- Library untuk membaca/menulis file Excel (SheetJS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Library untuk membuat PDF (jsPDF & jsPDF-AutoTable) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Tailwind CSS untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter untuk tampilan yang bersih dan modern -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Ikon (Feather Icons) -->
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        /* Menggunakan font Inter sebagai default */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Warna dasar GitHub Dark */
            color: #c9d1d9;
        }

        /* Efek Aurora di background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(13, 110, 253, 0.15), transparent 40%),
                radial-gradient(circle at 85% 30%, rgba(214, 40, 40, 0.15), transparent 40%);
            filter: blur(100px);
            z-index: -1;
        }

        /* Styling untuk area upload file (dropzone) */
        .drop-zone {
            border: 2px dashed #30363d;
            background-color: rgba(22, 27, 34, 0.5);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .drop-zone.dragover, .drop-zone:hover {
            background-color: rgba(33, 38, 45, 0.7);
            border-color: #2f81f7;
        }

        /* Styling glassmorphism untuk panel utama */
        .glass-panel {
            background: rgba(13, 17, 23, 0.6);
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        /* Styling tombol dengan gradien dan efek hover */
        .btn-gradient {
            background-image: linear-gradient(to right, #238636, #2ea043);
            border: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px 0 rgba(46, 160, 67, 0.3);
        }
        .btn-gradient:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 20px 0 rgba(46, 160, 67, 0.5);
        }
        .btn-secondary {
            background-color: #21262d;
            border: 1px solid #30363d;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #30363d;
            border-color: #8b949e;
        }

        /* Custom scrollbar untuk pratinjau tabel */
        .preview-container::-webkit-scrollbar { width: 8px; height: 8px; }
        .preview-container::-webkit-scrollbar-track { background: #0d1117; }
        .preview-container::-webkit-scrollbar-thumb { background-color: #21262d; border-radius: 10px; border: 2px solid #0d1117; }
        .preview-container::-webkit-scrollbar-thumb:hover { background-color: #30363d; }
        
        /* Menyembunyikan input file asli */
        #file-input { display: none; }
        
        /* Spinner untuk indikator loading */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: #2f81f7; /* Biru */
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Style untuk input tanggal agar ikon kalender terlihat */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.8);
            cursor: pointer;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-6xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-6xl font-extrabold text-white tracking-tight">
                Transformasi <span class="text-blue-400">Data</span> Instan
            </h1>
            <p class="mt-4 text-lg text-gray-400 max-w-2xl mx-auto">Unggah file CSV atau Excel, saring data sesuai kebutuhan, lalu ekspor ke format PDF atau Excel dengan mudah.</p>
        </header>

        <main id="converter-app" class="glass-panel rounded-2xl p-6 md:p-8">
            
            <!-- Tampilan Awal: Area Upload -->
            <div id="upload-area">
                <label for="file-input" class="drop-zone w-full p-10 rounded-xl flex flex-col items-center justify-center cursor-pointer text-gray-400">
                    <i data-feather="upload" class="w-16 h-16 mb-5 text-blue-500"></i>
                    <h2 class="text-2xl font-bold text-white">Letakkan File Anda Di Sini</h2>
                    <p class="mt-2 text-base">atau klik untuk menelusuri dari perangkat</p>
                    <p class="text-sm mt-5 bg-gray-700 px-3 py-1 rounded-full font-medium">Mendukung .csv, .xls, .xlsx</p>
                </label>
                <input type="file" id="file-input" accept=".csv,.xls,.xlsx">
            </div>

            <!-- Tampilan Proses: Loading Spinner -->
            <div id="loading-area" class="hidden flex-col items-center justify-center py-16">
                <div class="spinner"></div>
                <p class="mt-6 text-xl font-medium text-gray-300">Memproses data Anda...</p>
            </div>

            <!-- Tampilan Hasil: Pratinjau & Opsi Unduh -->
            <div id="workspace-area" class="hidden">
                <!-- Info File & Tombol Reset -->
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <div class="flex items-center text-lg bg-gray-800 px-4 py-2 rounded-lg border border-gray-700">
                        <i data-feather="file-text" class="w-5 h-5 mr-3 text-blue-400"></i>
                        <span id="file-info" class="font-medium"></span>
                    </div>
                    <button id="reset-btn" class="btn-secondary w-full sm:w-auto font-bold py-2 px-5 rounded-lg flex items-center justify-center">
                        <i data-feather="refresh-cw" class="w-5 h-5 mr-2"></i>
                        Unggah File Baru
                    </button>
                </div>

                <!-- Filter Data -->
                <div id="filter-section" class="mb-6 bg-gray-900/50 p-5 rounded-lg border border-gray-700">
                    <h3 class="text-xl font-semibold mb-4 flex items-center"><i data-feather="filter" class="w-5 h-5 mr-3 text-green-400"></i>Saring Data Pratinjau</h3>
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                        <div class="md:col-span-4">
                            <label for="filter-column" class="block text-sm font-medium text-gray-300 mb-1">Pilih Kolom untuk Filter</label>
                            <select id="filter-column" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></select>
                        </div>
                        
                        <!-- Kontainer untuk Filter Teks -->
                        <div id="text-filter-container" class="md:col-span-6">
                            <label for="filter-value" class="block text-sm font-medium text-gray-300 mb-1">Cari Kata Kunci</label>
                            <input type="text" id="filter-value" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ketikkan nilai untuk difilter...">
                        </div>

                        <!-- Kontainer untuk Filter Tanggal -->
                        <div id="date-filter-container" class="hidden md:col-span-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="start-date" class="block text-sm font-medium text-gray-300 mb-1">Dari Tanggal</label>
                                <input type="date" id="start-date" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="end-date" class="block text-sm font-medium text-gray-300 mb-1">Sampai Tanggal</label>
                                <input type="date" id="end-date" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>

                        <div class="md:col-span-2 flex gap-2">
                            <button id="apply-filter-btn" class="btn-gradient w-full text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center" title="Terapkan Filter">
                                <i data-feather="search" class="w-5 h-5"></i>
                            </button>
                            <button id="reset-filter-btn" class="btn-secondary w-auto py-2 px-3 rounded-lg flex items-center justify-center" title="Hapus Filter">
                                <i data-feather="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Pratinjau Data -->
                <div>
                    <h3 class="text-2xl font-bold mb-4 text-white">Pratinjau Data</h3>
                    <div class="preview-container max-h-96 overflow-auto border border-gray-700 rounded-lg bg-gray-900/70">
                        <table class="w-full text-sm text-left" id="preview-table">
                            <!-- Konten tabel akan diisi oleh JavaScript -->
                        </table>
                    </div>
                </div>

                <!-- Bagian Deteksi Data Duplikat -->
                <div id="detection-area" class="mt-8 hidden">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                        <h3 class="text-2xl font-bold text-white">Laporan Keterlambatan Berulang</h3>
                        <div class="flex gap-2">
                             <button id="download-detection-pdf-btn" class="btn-secondary w-full sm:w-auto font-bold py-2 px-4 rounded-lg flex items-center justify-center text-sm">
                                <i data-feather="file-text" class="w-4 h-4 mr-2"></i>
                                Unduh (PDF)
                            </button>
                            <button id="download-detection-excel-btn" class="btn-secondary w-full sm:w-auto font-bold py-2 px-4 rounded-lg flex items-center justify-center text-sm">
                                <i data-feather="grid" class="w-4 h-4 mr-2"></i>
                                Unduh (Excel)
                            </button>
                        </div>
                    </div>
                    <div class="preview-container max-h-72 overflow-auto border border-gray-700 rounded-lg bg-gray-900/70">
                        <table class="w-full text-sm text-left" id="detection-table">
                            <!-- Konten tabel deteksi akan diisi oleh JavaScript -->
                        </table>
                    </div>
                </div>

                <!-- Opsi Unduhan -->
                <div class="mt-8">
                    <h3 class="text-2xl font-bold mb-4 text-white">Opsi Ekspor</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Opsi Unduh PDF -->
                        <div class="bg-gray-800/50 p-6 rounded-xl border border-gray-700 flex flex-col">
                            <h4 class="text-xl font-semibold mb-4 flex items-center"><i data-feather="file" class="w-5 h-5 mr-3 text-red-400"></i>Ekspor Pratinjau ke PDF</h4>
                            <p class="text-gray-400 mb-4 flex-grow">Unduh data yang ditampilkan di pratinjau sebagai dokumen PDF. Anda bisa menambahkan judul kop surat.</p>
                            <div class="space-y-4">
                                <input type="text" id="pdf-title-input" class="w-full bg-gray-900 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-500 focus:ring-2 focus:ring-red-500 focus:border-red-500" placeholder="Judul Kop Surat (Opsional)">
                                <button id="download-pdf-btn" class="btn-secondary w-full font-bold py-2.5 px-4 rounded-lg flex items-center justify-center">
                                    <i data-feather="download" class="w-5 h-5 mr-2"></i>
                                    Unduh PDF
                                </button>
                            </div>
                        </div>

                        <!-- Opsi Unduh Excel -->
                        <div class="bg-gray-800/50 p-6 rounded-xl border border-gray-700 flex flex-col">
                            <h4 class="text-xl font-semibold mb-4 flex items-center"><i data-feather="grid" class="w-5 h-5 mr-3 text-green-400"></i>Ekspor Data Asli ke Excel</h4>
                            <p class="text-gray-400 mb-4 flex-grow">Simpan seluruh data asli (tanpa filter) dari file yang Anda unggah ke dalam format <code class="bg-gray-700 text-xs p-1 rounded">.xlsx</code>.</p>
                            <div class="mt-auto">
                                <button id="download-excel-btn" class="btn-gradient w-full text-white font-bold py-2.5 px-4 rounded-lg flex items-center justify-center">
                                    <i data-feather="download-cloud" class="w-5 h-5 mr-2"></i>
                                    Unduh Excel (Data Asli)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <footer class="text-center mt-10 text-gray-500 text-sm">
            <p>&copy; 2025 | Dibuat dengan <span class="text-red-500">❤️</span> oleh Mas Andy.</p>
        </footer>
    </div>

    <script>
        // Inisialisasi Feather Icons
        feather.replace();

        // Referensi Elemen DOM
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const loadingArea = document.getElementById('loading-area');
        const workspaceArea = document.getElementById('workspace-area');
        const fileInfo = document.getElementById('file-info');
        const previewTable = document.getElementById('preview-table');
        const pdfTitleInput = document.getElementById('pdf-title-input');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const downloadExcelBtn = document.getElementById('download-excel-btn');
        const resetBtn = document.getElementById('reset-btn');
        
        // Elemen Filter
        const filterColumnSelect = document.getElementById('filter-column');
        const textFilterContainer = document.getElementById('text-filter-container');
        const filterValueInput = document.getElementById('filter-value');
        const dateFilterContainer = document.getElementById('date-filter-container');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const applyFilterBtn = document.getElementById('apply-filter-btn');
        const resetFilterBtn = document.getElementById('reset-filter-btn');

        // Elemen Deteksi Duplikat
        const detectionArea = document.getElementById('detection-area');
        const detectionTable = document.getElementById('detection-table');
        const downloadDetectionExcelBtn = document.getElementById('download-detection-excel-btn');
        const downloadDetectionPdfBtn = document.getElementById('download-detection-pdf-btn');

        // Variabel global
        let parsedData = [];
        let filteredData = []; 
        let lateReportData = []; // Menyimpan data laporan keterlambatan
        let originalFileName = 'hasil-konversi';

        // --- FUNGSI UTAMA ---

        const handleFile = (file) => {
            if (!file) return;
            const isCsv = file.name.toLowerCase().endsWith('.csv');
            const isExcel = file.name.toLowerCase().endsWith('.xls') || file.name.toLowerCase().endsWith('.xlsx');
            if (!isCsv && !isExcel) {
                showToast('Format file tidak didukung. Harap gunakan CSV atau Excel.', 'error');
                return;
            }
            originalFileName = file.name.replace(/\.(csv|xlsx|xls)$/i, '');
            fileInfo.textContent = file.name;
            uploadArea.classList.add('hidden');
            loadingArea.classList.remove('hidden');
            workspaceArea.classList.add('hidden');
            
            setTimeout(() => {
                const reader = new FileReader();
                reader.onerror = () => { showToast('Gagal membaca file.', 'error'); resetApp(); };
                if (isCsv) {
                    reader.onload = (e) => { try { processCsv(e.target.result); } catch (error) { console.error("Error CSV:", error); showToast('Gagal memproses file CSV.', 'error'); resetApp(); } };
                    reader.readAsText(file);
                } else {
                    reader.onload = (e) => processExcel(e.target.result);
                    reader.readAsArrayBuffer(file);
                }
            }, 500);
        };

        const detectDelimiter = (csvText) => {
            const delimiters = [',', ';', '\t', '|'];
            const firstLine = csvText.slice(0, 1000).split('\n')[0];
            let bestDelimiter = ',';
            let maxCount = 0;
            delimiters.forEach(d => { const count = firstLine.split(d).length; if (count > maxCount) { maxCount = count; bestDelimiter = d; } });
            return bestDelimiter;
        };

        const processCsv = (csvText) => {
            const delimiter = detectDelimiter(csvText);
            const rows = [];
            let currentRow = [];
            let currentField = '';
            let inQuotes = false;
            csvText = csvText.trim() + '\n';
            for (let i = 0; i < csvText.length; i++) {
                const char = csvText[i];
                const nextChar = csvText[i + 1];
                if (inQuotes) {
                    if (char === '"' && nextChar === '"') { currentField += '"'; i++; } 
                    else if (char === '"') { inQuotes = false; } 
                    else { currentField += char; }
                } else {
                    if (char === '"') { inQuotes = true; } 
                    else if (char === delimiter) { currentRow.push(currentField.trim()); currentField = ''; } 
                    else if (char === '\n' || char === '\r') {
                        currentRow.push(currentField.trim());
                        if (currentRow.length > 1 || (currentRow.length === 1 && currentRow[0] !== '')) { rows.push(currentRow); }
                        currentRow = []; currentField = '';
                        if (char === '\r' && nextChar === '\n') { i++; }
                    } else { currentField += char; }
                }
            }
            parsedData = rows;
            finishProcessing();
        };

        const processExcel = (arrayBuffer) => {
            try {
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                const rows = [];
                const range = XLSX.utils.decode_range(worksheet['!ref']);
                for (let R = range.s.r; R <= range.e.r; ++R) {
                    const row = [];
                    for (let C = range.s.c; C <= range.e.c; ++C) {
                        const cell_address = { c: C, r: R };
                        const cell_ref = XLSX.utils.encode_cell(cell_address);
                        const cell = worksheet[cell_ref];
                        const cellValue = cell && cell.w ? cell.w : (cell && cell.v !== undefined ? cell.v : "");
                        row.push(String(cellValue));
                    }
                    rows.push(row);
                }
                
                parsedData = rows;
                finishProcessing();
            } catch (error) {
                console.error("Error Excel:", error);
                showToast('Gagal memproses file Excel.', 'error');
                resetApp();
            }
        };

        const finishProcessing = () => {
             if (!parsedData || parsedData.length === 0) {
                showToast('File kosong atau tidak dapat dibaca.', 'error');
                resetApp();
                return;
            }
            populateFilterOptions();
            updateFilterUI();
            resetFilter();
            loadingArea.classList.add('hidden');
            workspaceArea.classList.remove('hidden');
            feather.replace();
            showToast('File berhasil diproses!', 'success');
        };

        const populateFilterOptions = () => {
            filterColumnSelect.innerHTML = '';
            if (parsedData.length > 0) {
                parsedData[0].forEach((header, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = header;
                    filterColumnSelect.appendChild(option);
                });
            }
        };

        const renderPreview = (dataToRender) => {
            previewTable.innerHTML = '';
            if (!dataToRender || dataToRender.length <= 1) {
                // ... (kode untuk tabel kosong tidak berubah)
                return;
            };

            const headers = dataToRender[0];
            let body = dataToRender.slice(1);
            const indices = findColumnIndices(headers);

            // PENGURUTAN DATA PRATINJAU
            if (indices.tanggal !== -1) {
                body.sort((a, b) => {
                    const dateA = parseDate(a[indices.tanggal]);
                    const dateB = parseDate(b[indices.tanggal]);
                    if (dateA && dateB) return dateA.getTime() - dateB.getTime();
                    if (dateA) return -1;
                    if (dateB) return 1;
                    return 0;
                });
            }

            const thead = document.createElement('thead');
            thead.className = "text-xs text-gray-400 uppercase bg-gray-800";
            const headerRow = document.createElement('tr');
            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.scope = "col";
                th.className = "px-6 py-3 tracking-wider";
                th.textContent = headerText;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            previewTable.appendChild(thead);

            const tbody = document.createElement('tbody');
            body.forEach(rowData => {
                const row = document.createElement('tr');
                row.className = "bg-gray-900 border-b border-gray-700 hover:bg-gray-800/50";
                rowData.forEach(cellData => {
                    const td = document.createElement('td');
                    td.className = "px-6 py-4";
                    td.textContent = cellData || "";
                    row.appendChild(td);
                });
                tbody.appendChild(row);
            });
            previewTable.appendChild(tbody);
        };
        
        // --- LOGIKA FILTER & DETEKSI ---

        const parseDate = (dateString) => {
            if (!dateString) return null;
            if (dateString instanceof Date && !isNaN(dateString.getTime())) {
                return dateString;
            }
            if (typeof dateString !== 'string') {
                dateString = String(dateString);
            }
            const parts = dateString.match(/^(\d{1,2})[/-](\d{1,2})[/-](\d{4})(?:[ T](\d{1,2}):(\d{1,2})(?::(\d{1,2}))?)?/);
            if (parts) {
                const year = parseInt(parts[3], 10);
                const month = parseInt(parts[2], 10) - 1;
                const day = parseInt(parts[1], 10);
                const hour = parseInt(parts[4], 10) || 0;
                const minute = parseInt(parts[5], 10) || 0;
                const second = parseInt(parts[6], 10) || 0;
                const date = new Date(year, month, day, hour, minute, second);
                if (date.getFullYear() === year && date.getMonth() === month && date.getDate() === day) {
                    return date;
                }
            }
            const date = new Date(dateString);
            return isNaN(date.getTime()) ? null : date;
        };
        
        const isDateColumn = (columnIndex) => {
            if (parsedData.length < 2) return false;
            let dateCount = 0;
            const sampleSize = Math.min(10, parsedData.length - 1);
            for (let i = 1; i <= sampleSize; i++) {
                if (parsedData[i][columnIndex] && parseDate(parsedData[i][columnIndex])) {
                    dateCount++;
                }
            }
            return dateCount > sampleSize / 2;
        };

        const updateFilterUI = () => {
            const columnIndex = filterColumnSelect.value;
            if (isDateColumn(columnIndex)) {
                textFilterContainer.classList.add('hidden');
                dateFilterContainer.classList.remove('hidden');
            } else {
                textFilterContainer.classList.remove('hidden');
                dateFilterContainer.classList.add('hidden');
            }
        };

        const applyFilter = () => {
            const columnIndex = filterColumnSelect.value;
            const header = parsedData[0];
            const body = parsedData.slice(1);
            let results = [];

            if (isDateColumn(columnIndex)) {
                const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
                const endDate = endDateInput.value ? new Date(endDateInput.value) : null;
                if (startDate) startDate.setHours(0, 0, 0, 0);
                if (endDate) endDate.setHours(23, 59, 59, 999);
                
                if (!startDate && !endDate) {
                    resetFilter();
                    return;
                }

                results = body.filter(row => {
                    const cellDate = parseDate(row[columnIndex]);
                    if (!cellDate) return false;
                    const isAfterStart = !startDate || cellDate >= startDate;
                    const isBeforeEnd = !endDate || cellDate <= endDate;
                    return isAfterStart && isBeforeEnd;
                });
            } else {
                const filterText = filterValueInput.value.toLowerCase().trim();
                if (filterText === '') {
                    resetFilter();
                    return;
                }
                results = body.filter(row => {
                    const cellValue = row[columnIndex] ? String(row[columnIndex]).toLowerCase().trim() : '';
                    return cellValue.includes(filterText);
                });
            }

            filteredData = [header, ...results];
            renderPreview(filteredData);
            renderDetectionTable(filteredData);
            showToast(`${results.length} baris data ditemukan di pratinjau.`, 'info');
        };

        const resetFilter = () => {
            filterValueInput.value = '';
            startDateInput.value = '';
            endDateInput.value = '';
            filteredData = [...parsedData];
            renderPreview(filteredData);
            renderDetectionTable(filteredData);
        };

        const findColumnIndices = (headers) => {
            const findIndex = (keywords) => {
                for (const keyword of keywords) {
                    const index = headers.findIndex(h => h && h.toLowerCase().includes(keyword));
                    if (index !== -1) return index;
                }
                return -1;
            };
            return {
                nama: findIndex(['nama']),
                kelas: findIndex(['kelas', 'class']),
                tanggal: findIndex(['tanggal', 'date']),
            };
        };

        const renderDetectionTable = (data) => {
            lateReportData = [];
            detectionTable.innerHTML = '';

            if (!data || data.length <= 1) {
                detectionArea.classList.add('hidden');
                return;
            }
            
            const headers = data[0];
            const body = data.slice(1);
            const indices = findColumnIndices(headers);

            if (indices.nama === -1) {
                detectionArea.classList.remove('hidden');
                detectionTable.innerHTML = `<tbody><tr><td class="text-center text-gray-400 py-10">Analisis gagal: Kolom "Nama" tidak ditemukan.</td></tr></tbody>`;
                return;
            }

            const nameCounts = new Map();
            for (const row of body) {
                const name = row[indices.nama] ? String(row[indices.nama]).trim() : '';
                const className = indices.kelas !== -1 && row[indices.kelas] ? String(row[indices.kelas]).trim() : '';
                const key = `${name}|${className}`;
                
                if (name) {
                    nameCounts.set(key, (nameCounts.get(key) || 0) + 1);
                }
            }

            const reportDataStaging = [];
            for (const row of body) {
                const name = row[indices.nama] ? String(row[indices.nama]).trim() : '';
                const className = indices.kelas !== -1 && row[indices.kelas] ? String(row[indices.kelas]).trim() : '';
                const key = `${name}|${className}`;
                const totalCount = nameCounts.get(key) || 0;

                if (totalCount > 1) {
                    reportDataStaging.push({
                        row: row,
                        totalCount: totalCount
                    });
                }
            }
            
            // PENGURUTAN DATA
            reportDataStaging.sort((a, b) => {
                const nameA = a.row[indices.nama] || '';
                const nameB = b.row[indices.nama] || '';
                const dateA = parseDate(a.row[indices.tanggal]);
                const dateB = parseDate(b.row[indices.tanggal]);

                const nameComparison = nameA.localeCompare(nameB);
                if (nameComparison !== 0) {
                    return nameComparison;
                }
                
                if (dateA && dateB) {
                    return dateA.getTime() - dateB.getTime();
                }
                if (dateA) return -1;
                if (dateB) return 1;
                return 0;
            });

            lateReportData = reportDataStaging;

            if (lateReportData.length === 0) {
                detectionArea.classList.add('hidden');
                return;
            }
            detectionArea.classList.remove('hidden');

            const tableHeaders = ['Nama', 'Kelas', 'Hari', 'Tanggal', 'Total Keterlambatan'];
            if (indices.kelas === -1) {
                tableHeaders.splice(1, 1);
            }
            const thead = document.createElement('thead');
            thead.className = "text-xs text-gray-400 uppercase bg-gray-800";
            let headerHTML = '<tr>';
            tableHeaders.forEach(h => {
                headerHTML += `<th scope="col" class="px-6 py-3 tracking-wider">${h}</th>`;
            });
            headerHTML += '</tr>';
            thead.innerHTML = headerHTML;
            detectionTable.appendChild(thead);

            const tbody = document.createElement('tbody');
            const daysInIndonesian = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            
            lateReportData.forEach(item => {
                const rowData = item.row;
                const tr = document.createElement('tr');
                tr.className = "bg-gray-900 border-b border-gray-700 hover:bg-gray-800/50";

                const nameVal = rowData[indices.nama] || '';
                const classVal = indices.kelas !== -1 ? (rowData[indices.kelas] || '') : null;
                const originalDateVal = indices.tanggal !== -1 ? (rowData[indices.tanggal] || '') : '';
                let dayName = '';

                const d = parseDate(originalDateVal);
                if (d) {
                    dayName = daysInIndonesian[d.getDay()];
                }

                let rowHTML = `<td class="px-6 py-4 font-medium">${nameVal}</td>`;
                if (classVal !== null) {
                    rowHTML += `<td class="px-6 py-4">${classVal}</td>`;
                }
                rowHTML += `<td class="px-6 py-4">${dayName}</td>`;
                rowHTML += `<td class="px-6 py-4">${originalDateVal}</td>`;
                rowHTML += `<td class="px-6 py-4 text-center">${item.totalCount}</td>`;
                
                tr.innerHTML = rowHTML;
                tbody.appendChild(tr);
            });
            detectionTable.appendChild(tbody);
        };

        // --- FUNGSI UNDUH & UTILITAS ---

        const downloadDetectionData = (format) => {
            if (lateReportData.length === 0) {
                showToast('Tidak ada data keterlambatan berulang untuk diunduh.', 'error');
                return;
            }
            
            const headers = parsedData[0];
            const indices = findColumnIndices(headers);

            const tableHeaders = ['Nama', 'Kelas', 'Hari', 'Tanggal', 'Total Keterlambatan'];
            if (indices.kelas === -1) {
                tableHeaders.splice(1, 1);
            }
            
            const daysInIndonesian = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];

            const body = lateReportData.map(item => {
                const rowData = item.row;
                const nameVal = rowData[indices.nama] || '';
                const classVal = indices.kelas !== -1 ? (rowData[indices.kelas] || '') : null;
                const originalDateVal = indices.tanggal !== -1 ? (rowData[indices.tanggal] || '') : '';
                let dayName = '';

                const d = parseDate(originalDateVal);
                if (d) {
                    dayName = daysInIndonesian[d.getDay()];
                }

                const rowForExport = [
                    nameVal,
                    dayName,
                    originalDateVal,
                    item.totalCount
                ];
                
                if (classVal !== null) {
                    rowForExport.splice(1, 0, classVal);
                }

                return rowForExport;
            });

            if (format === 'excel') {
                const dataForSheet = [tableHeaders, ...body];
                const worksheet = XLSX.utils.aoa_to_sheet(dataForSheet);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Laporan Keterlambatan');
                XLSX.writeFile(workbook, `${originalFileName}_laporan_keterlambatan.xlsx`);
            } else if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });
                doc.autoTable({
                    head: [tableHeaders],
                    body: body,
                    startY: 80,
                    theme: 'grid',
                    styles: { font: 'helvetica', fillColor: [22, 27, 34], textColor: [201, 209, 217], lineColor: [48, 54, 61], lineWidth: 0.5 },
                    headStyles: { fillColor: [33, 38, 45], textColor: [240, 246, 252], fontStyle: 'bold' },
                    didDrawPage: function (data) {
                        doc.setFontSize(18);
                        doc.setTextColor('#2f81f7');
                        doc.setFont('helvetica', 'bold');
                        doc.text('Laporan Keterlambatan Berulang', doc.internal.pageSize.getWidth() / 2, 40, { align: 'center' });
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(150);
                        doc.text(`Sumber Data: ${fileInfo.textContent}`, doc.internal.pageSize.getWidth() / 2, 55, { align: 'center' });
                        doc.setDrawColor(48, 54, 61);
                        doc.setLineWidth(1);
                        doc.line(data.settings.margin.left, 68, doc.internal.pageSize.getWidth() - data.settings.margin.right, 68);
                    },
                });
                doc.save(`${originalFileName}_laporan_keterlambatan.pdf`);
            }
        };

        const downloadExcel = () => {
            if (parsedData.length === 0) { showToast('Tidak ada data untuk diunduh.', 'error'); return; }
            const worksheet = XLSX.utils.aoa_to_sheet(parsedData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Data Lengkap');
            XLSX.writeFile(workbook, `${originalFileName}_lengkap.xlsx`);
        };

        const downloadPdf = () => {
            let dataToDownload = filteredData.length > 1 ? filteredData : parsedData;
            if (dataToDownload.length <= 1) {
                showToast('Tidak ada data untuk diunduh (cek filter Anda).', 'error');
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });

            const title = pdfTitleInput.value.trim() || originalFileName;
            const head = [dataToDownload[0]];
            let body = dataToDownload.slice(1);
            const indices = findColumnIndices(head[0]);

            // PENGURUTAN DATA UNTUK PDF PRATINJAU
            if (indices.tanggal !== -1) {
                body.sort((a, b) => {
                    const dateA = parseDate(a[indices.tanggal]);
                    const dateB = parseDate(b[indices.tanggal]);
                    if (dateA && dateB) return dateA.getTime() - dateB.getTime();
                    if (dateA) return -1;
                    if (dateB) return 1;
                    return 0;
                });
            }

            doc.autoTable({
                head: head,
                body: body,
                startY: 80,
                theme: 'grid',
                styles: { font: 'helvetica', fillColor: [22, 27, 34], textColor: [201, 209, 217], lineColor: [48, 54, 61], lineWidth: 0.5 },
                headStyles: { fillColor: [33, 38, 45], textColor: [240, 246, 252], fontStyle: 'bold' },
                didDrawPage: function (data) {
                    doc.setFontSize(18);
                    doc.setTextColor('#2f81f7');
                    doc.setFont('helvetica', 'bold');
                    doc.text(title, doc.internal.pageSize.getWidth() / 2, 40, { align: 'center' });
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(150);
                    doc.text(`Sumber Data: ${fileInfo.textContent}`, doc.internal.pageSize.getWidth() / 2, 55, { align: 'center' });
                    doc.setDrawColor(48, 54, 61);
                    doc.setLineWidth(1);
                    doc.line(data.settings.margin.left, 68, doc.internal.pageSize.getWidth() - data.settings.margin.right, 68);
                },
            });
            doc.save(`${originalFileName}_difilter.pdf`);
        };

        const resetApp = () => {
            parsedData = [];
            filteredData = [];
            lateReportData = [];
            originalFileName = 'hasil-konversi';
            fileInput.value = '';
            pdfTitleInput.value = '';
            uploadArea.classList.remove('hidden');
            loadingArea.classList.add('hidden');
            workspaceArea.classList.add('hidden');
            detectionArea.classList.add('hidden');
        };

        const showToast = (message, type = 'info') => {
            const toast = document.createElement('div');
            const colors = { 
                info: 'bg-blue-500', 
                success: 'bg-green-500', 
                error: 'bg-red-600' 
            };
            toast.className = `fixed bottom-5 right-5 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform translate-y-24 opacity-0 transition-all duration-300 ease-out ${colors[type]}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => { toast.classList.remove('translate-y-24', 'opacity-0'); }, 100);
            setTimeout(() => { 
                toast.classList.add('opacity-0'); 
                setTimeout(() => toast.remove(), 500);
            }, 4000);
        };

        // --- EVENT LISTENERS ---
        fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
        const dropZone = document.querySelector('.drop-zone');
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); });
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); handleFile(e.dataTransfer.files[0]); });
        
        filterColumnSelect.addEventListener('change', updateFilterUI);
        applyFilterBtn.addEventListener('click', applyFilter);
        resetFilterBtn.addEventListener('click', () => {
            resetFilter();
            showToast('Filter telah dihapus.', 'info');
        });
        filterValueInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') applyFilter(); });
        
        downloadExcelBtn.addEventListener('click', downloadExcel);
        downloadPdfBtn.addEventListener('click', downloadPdf);
        downloadDetectionExcelBtn.addEventListener('click', () => downloadDetectionData('excel'));
        downloadDetectionPdfBtn.addEventListener('click', () => downloadDetectionData('pdf'));
        resetBtn.addEventListener('click', resetApp);

    </script>
</body>
</html>
